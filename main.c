#include <reg51.h>
#include <a1602.h>
#define uint unsigned int
#define uchar unsigned char

sbit voice=P1^3;		   //定义蜂鸣器接口
sbit key=P3^4;			   //定义按键接口
int i=0;				   //i用于计数按键次数

uchar code sound[]={0x60,0x40,0x60,0x40,0x40,0x40,0x40,0x40,0x39,0x40,0x39,0x40,0x40,0x40,
                    0x48,0x40,0x48,0x40,0x4c,0x40,0x4c,0x40,0x55,0x40,0x55,0x40,0x60,0x40,
                    0x40,0x40,0x40,0x40,0x48,0x40,0x48,0x40,0x4c,0x40,0x4c,0x40,0x55,0x40,
                    0x40,0x40,0x40,0x40,0x48,0x40,0x48,0x40,0x4c,0x40,0x4c,0x40,0x55,0x40,0x00,
                   };				//歌曲频率表
uchar code sound1[]={0xff,0x40,0xff,0x40,0x4c,0x20,0x40,0x20,0x39,0x20,0xff,0x20,0x40,0x20,
                    0x39,0x20,0xff,0x20,0x40,0x20,0x39,0x20,0x30,0x20,0x40,0x20,0x39,0x20,
                    0x4c,0x20,0xff,0x20,0x4c,0x20,0x40,0x20,0x39,0x20,0xff,0x20,0x40,0x20,
                    0x39,0x20,0xff,0x20,0x40,0x20,0x39,0x20,0x26,0x20,0x30,0x20,0x2b,0x20,
                    0x39,0x20,0xff,0x20,0x4c,0x20,0x40,0x20,0x39,0x20,0xff,0x20,0x40,0x20,
                    0x39,0x20,0xff,0x20,0x40,0x20,0x39,0x20,0x30,0x20,0x40,0x20,0x39,0x20,
                    0x4c,0x20,0x40,0x20,0x60,0x20,0x55,0x20,0x4c,0x40,0x30,0x40,0x39,0x40,
                    0x26,0x40,0x2b,0x20,0x26,0x10,0x2b,0x10,0x30,0x20,0x2b,0x20,0x39,0x40,
                    0xff,0x40,0x39,0x40,0x39,0x40,0x39,0x40,0x39,0x10,0x30,0x10,0x2b,0x10,0x26,0x10,
                    0x39,0x40,0x39,0x40,0x39,0x20,0x40,0x20,0x40,0x20,0x39,0x20,0x39,0x40,
                    0x39,0x40,0x39,0x40,0x39,0x10,0x30,0x10,0x2b,0x10,0x26,0x10,0x39,0x40,
                    0x39,0x40,0x39,0x20,0x24,0x20,0x24,0x20,0x26,0x20,0x39,0x40,0x39,0x40,0x39,0x40,0x39,0x10,0x30,0x10,0x2b,0x10,0x26,0x10,
                    0x39,0x40,0x39,0x40,0x39,0x20,0x40,0x20,0x40,0x20,0x39,0x20,0x39,0x40,
                    0x39,0x40,0x39,0x40,0x39,0x10,0x30,0x10,0x2b,0x10,0x26,0x10,0x1c,0x40,
                    0xff,0x10,0x40,0x20,0x40,0x20,0x39,0x20,0x39,0x40,0x00,
					};
uchar code sound2[]={0x60,0x40,0x60,0x40,0x40,0x40,0x40,0x40,0x39,0x40,0x39,0x40,0x40,0x40,
                    0x48,0x40,0x48,0x40,0x4c,0x40,0x4c,0x40,0x55,0x40,0x55,0x40,0x60,0x40,
                    0x40,0x40,0x40,0x40,0x48,0x40,0x48,0x40,0x4c,0x40,0x4c,0x40,0x55,0x40,
                    0x40,0x40,0x40,0x40,0x48,0x40,0x48,0x40,0x4c,0x40,0x4c,0x40,0x55,0x40,0x00,
                   };					

uchar jp;

uint j=0,k=0;

void DelayMS(uint x);	           //毫秒延时 函数原型
void play(unsigned char *sound);   //播放函数原型

void main(){
while(1)
{
    unsigned char song[3][20] = {"small stars","happy land","happy birthday"};	  //歌曲目录
	unsigned char welcome[20] = "welcome to use !";								  //欢迎界面
    TMOD=0x01;			//设置定时器T0工作于方式1
	IE=0x82;			//允许T0中断
    TH0=0xd8;
	TL0=0xef;			//设置计时器的初始值
	TR0=1;				//开始计时
	LCD_Init();         //1602初始化
	
	if(!key)
	{				 //判断按钮按下
		DelayMS(100);	//延时按钮消抖
		if(!key)
		{
			i++;}
					}
	switch(i%3)
	{
		case 0:LCD_Clear();LCD_Write_String(0,1,welcome);LCD_Write_String(0,2,song[i]);play(sound);break;	//确定播放的是哪首歌并输出到液晶屏上
		case 1:LCD_Clear();LCD_Write_String(0,1,welcome);LCD_Write_String(0,2,song[i]);play(sound1);break;
		case 2:LCD_Clear();LCD_Write_String(0,1,welcome);LCD_Write_String(0,2,song[i]);play(sound2);break;
    }
}


}

time0() interrupt 1 using 1{					   //计时器1
    TH0=0xd8;
	TL0=0xef;
}

void DelayMS(uint x){		//毫秒暂停
    uchar t;
    while(x--)
        for(t=0;t<120;t++);
}

void play(unsigned char *sound){				   //播放函数
	uint dpjs=0;		//读谱技术，从0开始
    uchar yj;			//每个音节
	
	yj=sound[dpjs]; //读取音节
		while(yj!=0x00){
			dpjs=dpjs+1;
			jp=sound[dpjs];			//读取节拍
			if(yj!=0xff){		//音节不为休止符
				for(j=0;j<jp*24;j++){
					voice=~voice;
					for(k=0;k<yj*2;k++); 
				}
				voice=0;
			}else{		//休止符，不播放
				voice=0;
				for(j=0;j<jp*24;j++){
					for(k=0;k<yj*2;k++); 
				}
			}
			j=0,k=0;
			DelayMS(75);
			dpjs=dpjs+1;
			yj=sound[dpjs]; //读取音节
		}
		i++;
		dpjs=0;	
}
